name: ğŸš€ Actualizar Actividad Reciente

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  update-activity:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # Historial completo para estadÃ­sticas correctas

    - name: ğŸ“Š Obtener estadÃ­sticas de actividad
      id: stats
      run: |
        # â”€â”€ Ãšltimos 5 commits (tiempo relativo traducido al espaÃ±ol) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        translate_time() {
          echo "$1" \
            | sed -E 's/([0-9]+) seconds? ago/hace \1 segundos/g' \
            | sed -E 's/([0-9]+) minutes? ago/hace \1 minutos/g' \
            | sed -E 's/([0-9]+) hours? ago/hace \1 horas/g' \
            | sed -E 's/([0-9]+) days? ago/hace \1 dÃ­as/g' \
            | sed -E 's/([0-9]+) weeks? ago/hace \1 semanas/g' \
            | sed -E 's/([0-9]+) months? ago/hace \1 meses/g' \
            | sed -E 's/a minute ago/hace 1 minuto/g' \
            | sed -E 's/an hour ago/hace 1 hora/g' \
            | sed -E 's/a day ago/hace 1 dÃ­a/g' \
            | sed -E 's/a week ago/hace 1 semana/g' \
            | sed -E 's/a month ago/hace 1 mes/g'
        }

        RAW_COMMITS=$(git log --oneline -n 5 --pretty=format:"- %s (%ar)")
        COMMITS=$(translate_time "$RAW_COMMITS")

        # â”€â”€ Commits de la Ãºltima semana â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        WEEK_COMMITS=$(git rev-list --count --since="1 week ago" HEAD)

        # â”€â”€ LÃ­neas agregadas/eliminadas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        INSERTIONS=0
        DELETIONS=0
        if [ "$WEEK_COMMITS" -gt 0 ]; then
          LINES_STATS=$(git diff --shortstat "HEAD~${WEEK_COMMITS}" HEAD 2>/dev/null || true)
          if [ -n "$LINES_STATS" ]; then
            INSERTIONS=$(echo "$LINES_STATS" | grep -oP '\d+(?= insertion)' || echo "0")
            DELETIONS=$(echo "$LINES_STATS"  | grep -oP '\d+(?= deletion)'  || echo "0")
          fi
        fi

        # â”€â”€ Ramas remotas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ACTIVE_REPOS=$(git branch -r 2>/dev/null | wc -l || echo "1")

        # â”€â”€ Estrellas del repositorio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        STARS=$(curl -sf "https://api.github.com/repos/${{ github.repository }}" \
          | grep -oP '(?<="stargazers_count": )\d+' || echo "0")

        # â”€â”€ Fecha en espaÃ±ol â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        CURRENT_DATE=$(date -u "+%A, %d de %B de %Y, %H:%M:%S UTC" \
          | sed 's/Monday/Lunes/; s/Tuesday/Martes/; s/Wednesday/MiÃ©rcoles/
                 s/Thursday/Jueves/; s/Friday/Viernes/; s/Saturday/SÃ¡bado/; s/Sunday/Domingo/' \
          | sed 's/January/Enero/; s/February/Febrero/; s/March/Marzo/; s/April/Abril/
                 s/May/Mayo/; s/June/Junio/; s/July/Julio/; s/August/Agosto/
                 s/September/Septiembre/; s/October/Octubre/; s/November/Noviembre/; s/December/Diciembre/')

        # â”€â”€ Exportar outputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        {
          echo "commits<<EOF"
          echo "$COMMITS"
          echo "EOF"
          echo "week_commits=$WEEK_COMMITS"
          echo "insertions=${INSERTIONS:-0}"
          echo "deletions=${DELETIONS:-0}"
          echo "active_repos=$ACTIVE_REPOS"
          echo "stars=$STARS"
          echo "current_date=$CURRENT_DATE"
        } >> "$GITHUB_OUTPUT"

    - name: âœï¸ Actualizar README con nueva actividad
      run: |
        README=".github/README.md"

        # â”€â”€ Construir bloque de actividad â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # El encabezado estÃ¡ DENTRO para evitar duplicados fuera del bloque
        export ACTIVITY_BLOCK="<!--RECENT_ACTIVITY:start-->
        ## ğŸ“ˆ Actividad Reciente

        ### ğŸš€ Ãšltimos Commits
        ${{ steps.stats.outputs.commits }}

        ### ğŸ“Š EstadÃ­sticas Semanales
        - ğŸ’» **Commits esta semana**: ${{ steps.stats.outputs.week_commits }}
        - ğŸ”¥ **LÃ­neas de cÃ³digo**: +${{ steps.stats.outputs.insertions }} / -${{ steps.stats.outputs.deletions }}
        - ğŸ“¦ **Repositorios activos**: ${{ steps.stats.outputs.active_repos }}
        - ğŸŒŸ **Estrellas del repositorio**: ${{ steps.stats.outputs.stars }}

        **Ãšltima actualizaciÃ³n**: ${{ steps.stats.outputs.current_date }}
        <!--RECENT_ACTIVITY:end-->"

        if grep -q "<!--RECENT_ACTIVITY:start-->" "$README"; then
          echo "ğŸ”„ Actualizando secciÃ³n existente..."
          python3 -c "
        import os
        import re
        import sys

        readme_path = '$README'
        activity_block = os.environ['ACTIVITY_BLOCK']

        with open(readme_path, 'r', encoding='utf-8') as f:
            content = f.read()

        # PatrÃ³n para encontrar el bloque completo (multilÃ­nea)
        pattern = r'<!--RECENT_ACTIVITY:start-->.*?<!--RECENT_ACTIVITY:end-->'
        
        if re.search(pattern, content, re.DOTALL):
            # Reemplazamos el bloque existente
            new_content = re.sub(pattern, activity_block, content, flags=re.DOTALL)
            with open(readme_path, 'w', encoding='utf-8') as f:
                f.write(new_content)
            print('âœ… Bloque actualizado con Ã©xito.')
        else:
            print('âš ï¸ Marcadores encontrados por grep pero no por regex. Reintentando apÃ©ndice...')
            sys.exit(1)
        " || (echo "â• Agregando al final por fallo de regex..." && printf '\n---\n\n%s\n' "$ACTIVITY_BLOCK" >> "$README")
        else
          echo "â• Agregando nueva secciÃ³n al final..."
          printf '\n---\n\n%s\n' "$ACTIVITY_BLOCK" >> "$README"
        fi

    - name: ğŸš€ Commit y Push de cambios
      run: |
        git config --local user.email "javasan.dev@gmail.com"
        git config --local user.name "JavAsanDev"

        if git diff --quiet; then
          echo "âœ… No hay cambios para commitear"
        else
          git add .github/README.md
          git commit -m "ğŸ¤– ActualizaciÃ³n automÃ¡tica de actividad reciente"
          git push
          echo "âœ… README actualizado exitosamente!"
        fi